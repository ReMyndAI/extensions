{% extends "base.html" %}
{% block head %}
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Avenir:wght@350;500&display=swap" />
{% endblock %}

{% block style %}
  .main-container {
    overflow: hidden;
  }
  
  .main-container,
  .main-container * {
    box-sizing: border-box;
  }
  
  .main-container {
    display: flex;
    flex-direction: column;
    align-items: flex-start;
    flex-wrap: nowrap;
    gap: 20px;
    position: relative;
    min-width: 420px;
    margin: 0 auto;
    padding: 20px 24px 0px 24px;
    background: #1f1f1f;
  }
  .frame {
    display: flex;
    flex-direction: column;
    align-items: flex-start;
    align-self: stretch;
    flex-wrap: nowrap;
    flex-shrink: 0;
    gap: 16px;
    position: relative;
    min-width: 0;
  }
  .frame-1 {
    display: flex;
    align-items: center;
    flex-wrap: nowrap;
    flex-shrink: 0;
    gap: 24px;
    position: relative;
    z-index: 1;
  }
  .icon {
    display: flex;
    align-items: center;
    justify-content: center;
    flex-wrap: nowrap;
    flex-shrink: 0;
    gap: 10px;
    position: relative;
    width: 14px;
    z-index: 2;
    border-radius: 3px;
  }
  .rectangle {
    flex-shrink: 0;
    position: absolute;
    width: 24px;
    height: 24px;
    top: 50%;
    left: 50%;
    background: rgba(64, 209, 255, 0.15);
    transform: translate(-50%, -50%);
    z-index: 3;
    border-radius: 6px;
  }
  .group {
    flex-shrink: 0;
    position: relative;
    width: 14px;
    height: 14px;
    background: url("data:image/png;base64,{{ encodeImage("assets/images/b1937c60-8177-4d19-9fe9-bd4749109a92.png") | safe }}")
      no-repeat center;
    background-size: cover;
    z-index: 4;
  }
  .call-name-title {
    flex-shrink: 1;
    flex-basis: auto;
    position: relative;
    font-family: Avenir, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
      Ubuntu, "Helvetica Neue", Helvetica, Arial, "PingFang SC",
      "Hiragino Sans GB", "Microsoft Yahei UI", "Microsoft Yahei",
      "Source Han Sans CN", sans-serif;
    color: #f1f1f1;
    font-size: 21px;
    font-weight: 350;
    line-height: 22.5px;
    text-align: left;
    letter-spacing: -0.84px;
    margin-bottom: -4px;
    white-space: pre-wrap;
    z-index: 6;
  }
  .dates {
    display: flex;
    align-items: center;
    align-self: stretch;
    flex-wrap: nowrap;
    flex-shrink: 0;
    gap: 24px;
    position: relative;
    z-index: 7;
  }
  .date-and-time {
    display: flex;
    flex-direction: column;
    align-items: flex-start;
    align-self: stretch;
    flex-wrap: nowrap;
    flex-shrink: 0;
    gap: 12px;
    position: relative;
    z-index: 8;
  }
  .app {
    flex-shrink: 0;
    position: relative;
    height: 8px;
    font-family: Avenir, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
      Ubuntu, "Helvetica Neue", Helvetica, Arial, "PingFang SC",
      "Hiragino Sans GB", "Microsoft Yahei UI", "Microsoft Yahei",
      "Source Han Sans CN", sans-serif;
    color: #8d8d8d;
    font-size: 12px;
    font-weight: 350;
    line-height: 8px;
    text-align: left;
    white-space: nowrap;
    letter-spacing: -0.48px;
    z-index: 9;
  }
  .name {
    display: flex;
    align-items: flex-start;
    flex-wrap: nowrap;
    flex-shrink: 0;
    gap: 10px;
    position: relative;
    padding: 0 0 0 30px;
    z-index: 10;
  }
  .zoom {
    flex-shrink: 0;
    position: relative;
    height: 11px;
    font-family: Avenir, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
      Ubuntu, "Helvetica Neue", Helvetica, Arial, "PingFang SC",
      "Hiragino Sans GB", "Microsoft Yahei UI", "Microsoft Yahei",
      "Source Han Sans CN", sans-serif;
    color: #f1f1f1;
    font-size: 15px;
    font-weight: 350;
    line-height: 11px;
    text-align: left;
    white-space: nowrap;
    letter-spacing: -0.6px;
    z-index: 11;
  }
  .zoom-2 {
    flex-shrink: 0;
    position: absolute;
    width: 18px;
    height: 18px;
    top: -3.769px;
    left: 0;
    background: url("data:image/png;base64,{{ encodeImage("assets/images/5a3187eb-90c8-4a0e-bf98-bb293ba809a6.png") | safe }}")
      no-repeat center;
    background-size: cover;
    z-index: 12;
  }
  .rectangle-3 {
    align-self: stretch;
    flex-shrink: 0;
    position: relative;
    width: 1px;
    background: #404040;
    z-index: 13;
  }
  .date-and-time-4 {
    display: flex;
    flex-direction: column;
    align-items: flex-start;
    align-self: stretch;
    flex-wrap: nowrap;
    flex-shrink: 0;
    gap: 12px;
    position: relative;
    width: 79px;
    z-index: 14;
  }
  .date {
    flex-shrink: 0;
    position: relative;
    height: 8px;
    font-family: Avenir, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
      Ubuntu, "Helvetica Neue", Helvetica, Arial, "PingFang SC",
      "Hiragino Sans GB", "Microsoft Yahei UI", "Microsoft Yahei",
      "Source Han Sans CN", sans-serif;
    color: #8d8d8d;
    font-size: 12px;
    font-weight: 350;
    line-height: 8px;
    text-align: left;
    white-space: nowrap;
    letter-spacing: -0.48px;
    z-index: 15;
  }
  .wed-nov {
    flex-shrink: 0;
    position: relative;
    height: 11px;
    font-family: Avenir, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
      Ubuntu, "Helvetica Neue", Helvetica, Arial, "PingFang SC",
      "Hiragino Sans GB", "Microsoft Yahei UI", "Microsoft Yahei",
      "Source Han Sans CN", sans-serif;
    color: #f1f1f1;
    font-size: 15px;
    font-weight: 350;
    line-height: 11px;
    text-align: left;
    white-space: nowrap;
    letter-spacing: -0.6px;
    z-index: 16;
  }
  .rectangle-5 {
    align-self: stretch;
    flex-shrink: 0;
    position: relative;
    width: 1px;
    background: #404040;
    z-index: 17;
  }
  .date-and-time-6 {
    display: flex;
    flex-direction: column;
    align-items: flex-start;
    align-self: stretch;
    flex-wrap: nowrap;
    flex-grow: 1;
    flex-shrink: 0;
    flex-basis: 0;
    gap: 12px;
    position: relative;
    z-index: 18;
  }
  .span-time {
    flex-shrink: 0;
    position: relative;
    height: 8px;
    font-family: Avenir, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
      Ubuntu, "Helvetica Neue", Helvetica, Arial, "PingFang SC",
      "Hiragino Sans GB", "Microsoft Yahei UI", "Microsoft Yahei",
      "Source Han Sans CN", sans-serif;
    color: #8d8d8d;
    font-size: 12px;
    font-weight: 350;
    line-height: 8px;
    text-align: left;
    white-space: nowrap;
    letter-spacing: -0.48px;
    z-index: 19;
  }
  .span-pm {
    flex-shrink: 0;
    position: relative;
    height: 11px;
    font-family: Avenir, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
      Ubuntu, "Helvetica Neue", Helvetica, Arial, "PingFang SC",
      "Hiragino Sans GB", "Microsoft Yahei UI", "Microsoft Yahei",
      "Source Han Sans CN", sans-serif;
    color: #f1f1f1;
    font-size: 15px;
    font-weight: 350;
    line-height: 11px;
    text-align: left;
    white-space: nowrap;
    letter-spacing: -0.6px;
    z-index: 20;
  }
  .date-and-time-7 {
    display: flex;
    flex-direction: column;
    align-items: flex-end;
    align-self: stretch;
    flex-wrap: nowrap;
    flex-shrink: 0;
    gap: 12px;
    position: relative;
    width: 61px;
    z-index: 21;
  }
  .span-duration {
    flex-shrink: 0;
    position: relative;
    height: 8px;
    font-family: Avenir, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
      Ubuntu, "Helvetica Neue", Helvetica, Arial, "PingFang SC",
      "Hiragino Sans GB", "Microsoft Yahei UI", "Microsoft Yahei",
      "Source Han Sans CN", sans-serif;
    color: #8d8d8d;
    font-size: 12px;
    font-weight: 350;
    line-height: 8px;
    text-align: left;
    white-space: nowrap;
    letter-spacing: -0.48px;
    z-index: 22;
  }
  .span-min {
    flex-shrink: 0;
    position: relative;
    height: 11px;
    font-family: Avenir, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
      Ubuntu, "Helvetica Neue", Helvetica, Arial, "PingFang SC",
      "Hiragino Sans GB", "Microsoft Yahei UI", "Microsoft Yahei",
      "Source Han Sans CN", sans-serif;
    color: #f1f1f1;
    font-size: 15px;
    font-weight: 350;
    line-height: 11px;
    text-align: left;
    white-space: nowrap;
    letter-spacing: -0.6px;
    z-index: 23;
  }
  .rectangle-8 {
    align-self: stretch;
    flex-shrink: 0;
    position: relative;
    min-width: 0;
    height: 1px;
    background: #404040;
    z-index: 24;
  }
  .avatars {
    display: flex;
    align-items: center;
    flex-direction: row;
    flex-wrap: nowrap;
    flex-shrink: 0;
    gap: 6px;
    position: relative;
    width: 100%;
    z-index: 25;
  }
  .description {
    display: flex;
    align-items: center;
    flex-wrap: nowrap;
    flex-shrink: 0;
    gap: 10px;
    position: relative;
    width: 48px;
    padding: 0 12px 0 0;
    z-index: 26;
  }
  .span-people {
    flex-shrink: 0;
    position: relative;
    height: 8px;
    font-family: Avenir, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
      Ubuntu, "Helvetica Neue", Helvetica, Arial, "PingFang SC",
      "Hiragino Sans GB", "Microsoft Yahei UI", "Microsoft Yahei",
      "Source Han Sans CN", sans-serif;
    color: #f1f1f1;
    font-size: 12px;
    font-weight: 350;
    line-height: 8px;
    text-align: left;
    white-space: nowrap;
    letter-spacing: -0.48px;
    z-index: 27;
  }
  .participants, a {
    display: inline-box;
    font-family: Avenir, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
      Ubuntu, "Helvetica Neue", Helvetica, Arial, "PingFang SC",
      "Hiragino Sans GB", "Microsoft Yahei UI", "Microsoft Yahei",
      "Source Han Sans CN", sans-serif;
    color: #a1a1a1;
    font-size: 14px;
    font-weight: 400;
    line-height: 16px;
    text-align: left;
    letter-spacing: -0.48px;
    z-index: 27;
  }
  a:hover {
    color: #f1f1f1;
  }
  .audio {
    display: flex;
    align-items: center;
    align-self: stretch;
    flex-wrap: nowrap;
    flex-shrink: 0;
    gap: 15px;
    position: relative;
    min-width: 0;
    padding: 12px 12px 12px 12px;
    background: #303030;
    z-index: 35;
    border-radius: 6px;
  }
  .audio > audio {
    width: 100%;
  }
  .tabbar {
    display: flex;
    flex-direction: column;
    align-items: flex-start;
    align-self: stretch;
    flex-wrap: nowrap;
    flex-shrink: 0;
    gap: 12px;
    position: relative;
    min-width: 0;
    z-index: 66;
  }
  .tabbar-header {
    display: flex;
    align-items: center;
    flex-wrap: nowrap;
    flex-shrink: 0;
    gap: 10px;
    position: relative;
    z-index: 66;
  }
  .scroll-content {
    height: calc(100vh - 312px);
    overflow-y: scroll;
  }
  .transcript-items {
    display: flex;
    flex-flow: column;
    flex: 1 1 auto;
    gap: 2px;
    font-family: Avenir, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
      Ubuntu, "Helvetica Neue", Helvetica, Arial, "PingFang SC",
      "Hiragino Sans GB", "Microsoft Yahei UI", "Microsoft Yahei",
      "Source Han Sans CN", sans-serif;
    font-size: 15px;
    font-weight: 350;
    letter-spacing: -0.6px;
    color: #f1f1f1;
  }
  .path-indicator {
    display: flex;
    align-items: flex-start;
    align-self: stretch;
    flex-wrap: nowrap;
    flex-shrink: 0;
    gap: 10px;
    position: relative;
    padding: 9px 9px 9px 9px;
    z-index: 67;
    border-radius: 6px;
    cursor: pointer;
  }
  .path-indicator-active {
    background: #322d32;
  }
  .tab-item {
    flex-shrink: 0;
    position: relative;
    height: 8px;
    font-family: Avenir, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
      Ubuntu, "Helvetica Neue", Helvetica, Arial, "PingFang SC",
      "Hiragino Sans GB", "Microsoft Yahei UI", "Microsoft Yahei",
      "Source Han Sans CN", sans-serif;
    color: #919191;
    font-size: 12px;
    font-weight: 350;
    line-height: 8px;
    text-align: left;
    white-space: nowrap;
    letter-spacing: -0.48px;
    z-index: 68;
  }
  .path-indicator-active > .tab-item {
    color: #f1f1f1;
  }
  .divider {
    align-self: stretch;
    flex-shrink: 0;
    position: relative;
    height: 1px;
    background: #404040;
    z-index: 68;
  }
  .transcript-section {
    display: flex;
    align-items: flex-start;
    align-self: stretch;
    flex-wrap: nowrap;
    flex-shrink: 0;
    gap: 18px;
    position: relative;
    z-index: 69;
    cursor: pointer;
  }
  .transcript-section:hover {
    background: rgba(64, 64, 64, 0.15);
  }
  .person {
    display: flex;
    align-items: center;
    flex-wrap: nowrap;
    flex-shrink: 0;
    gap: 2px;
    position: relative;
    width: 64px;
    z-index: 70;
  }
  .dot {
    flex-shrink: 0;
    position: relative;
    width: 6px;
    height: 6px;
    background: url("data:image/png;base64,{{ encodeImage("assets/images/b850c630-6510-47f4-8c39-1ffc0f3fe1ab.png") | safe }}")
      no-repeat center;
    background-size: cover;
    z-index: 71;
    border-radius: 50%;
    margin: 0 4px;
  }
  .transcript-section-active .dot {
    background: url("data:image/png;base64,{{ encodeImage("assets/images/c84e2358-9e52-4359-9838-9fbd3596a76b.png") | safe }}")
      no-repeat center;
  }
  .transcript-timestamp {
    flex-shrink: 0;
    position: relative;
    font-family: Avenir, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
      Ubuntu, "Helvetica Neue", Helvetica, Arial, "PingFang SC",
      "Hiragino Sans GB", "Microsoft Yahei UI", "Microsoft Yahei",
      "Source Han Sans CN", sans-serif;
    color: #8d8d8d;
    font-size: 12px;
    font-weight: 350;
    line-height: 22.5px;
    text-align: left;
    white-space: nowrap;
    letter-spacing: -0.48px;
    z-index: 72;
  }
  .transcript-section-active .transcript-timestamp {
    color: #b2b2b2;
  }
  .transcript-paragraph {
    display: flex;
    align-items: flex-start;
    flex-wrap: wrap;
    flex-grow: 1;
    flex-shrink: 0;
    flex-basis: 0;
    gap: 9px;
    position: relative;
    z-index: 73;
  }
  .transcript-paragraph-text {
    display: flex;
    align-items: flex-start;
    justify-content: flex-start;
    flex-grow: 1;
    flex-basis: 0;
    position: relative;
    font-family: Avenir, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
      Ubuntu, "Helvetica Neue", Helvetica, Arial, "PingFang SC",
      "Hiragino Sans GB", "Microsoft Yahei UI", "Microsoft Yahei",
      "Source Han Sans CN", sans-serif;
    color: #8d8d8d;
    font-size: 15px;
    font-weight: 350;
    line-height: 22.5px;
    text-align: left;
    letter-spacing: -0.6px;
    z-index: 74;
  }
  .transcript-section-active .transcript-paragraph-text {
    color: #f1f1f1;
  }
  .summary-content {
    display: flex;
    flex-flow: column;
    align-items: flex-start;
    justify-content: flex-start;
    flex-shrink: 0;
    position: relative;
    color: #f1f1f1;
    font-family: Avenir, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
      Ubuntu, "Helvetica Neue", Helvetica, Arial, "PingFang SC",
      "Hiragino Sans GB", "Microsoft Yahei UI", "Microsoft Yahei",
      "Source Han Sans CN", sans-serif;
    font-size: 15px;
    font-weight: 350;
    line-height: 22.5px;
    text-align: left;
    letter-spacing: -0.6px;
    z-index: 74;
  }
  .topic-title {
    margin-top: 0.5em;
    margin-bottom: 0.5em;
    padding: 12px;
    background: #303030;
    width: 100%;
    z-index: 80;
    border-radius: 6px;
    color: #b2b2b2;
    cursor: pointer;
  }  
  .topic-active > .topic-title {
    color: #f1f1f1;
  }
  .topic-text {
    margin-top: 0.5em;
    margin-bottom: 1em;
    padding-left: 8px;
    color: #8d8d8d;
  }  
  .topic-active > .topic-text {
    color: #b2b2b2;
  }
  .summary-content a {
    padding: 10px 14px;
    background: rgba(48, 48, 48, 0.5);
    border-radius: 6px;
    text-decoration: none;
  }
  .summary-content a:hover {
    background: rgba(48, 48, 48, 0.8);
  }
  .summary-content a.clicked:hover {
    background: rgba(48, 48, 48, 0.5);
  }
{% endblock %}

{% block content %}

<div class="main-container">
    <div class="frame">
      <div class="frame-1">
        <div class="icon">
          <div class="rectangle"></div>
          <div class="group"></div>
        </div>
        <span class="call-name-title" contenteditable="plaintext-only">{{ title }}</span>
      </div>
      <div class="dates">
        <div class="date-and-time">
          <span class="app">APP</span>
          <div class="name">
            <span class="zoom">{{ call['appName'] }}</span>
            <div class="zoom-2"></div>
          </div>
        </div>
        <div class="rectangle-3"></div>
        <div class="date-and-time-4">
          <span class="date">DATE</span>
          <span class="wed-nov">{{ dateStr(call['startDate']) }}</span>
        </div>
        <div class="rectangle-5"></div>
        <div class="date-and-time-6">
          <span class="span-time">TIME</span
          ><span class="span-pm">{{ timeStr(call['startDate']) }}</span>
        </div>
        <div class="date-and-time-7">
          <span class="span-duration">DURATIION</span>
          <span class="span-min">{{ ((call['endDate'] - call['startDate']) / 60)|int if call.get('endDate') else ((getTimestamp() - call['startDate']) / 60)|int }} min</span>
        </div>
      </div>
    </div>
    <div class="rectangle-8"></div>
    <div class="avatars">
      <div class="description"><span class="span-people">People</span></div>
      <div class="participants">
      {% for p in call.get('participants') or [] %}
      <a href="#" class="participant">{{ p }}</a>{% if not loop.last %}, {% endif %}
      {% endfor %}
      </div>
    </div>
    <div class="audio">
      <audio controls src="{{ audio_src }}"></audio>
    </div>
    <div class="tabbar">
      <div class="tabbar-header">
        <div id="transcription" class="path-indicator path-indicator-active">
            <span class="tab-item">TRANSCRIPT</span>
        </div>
        <div id="summary" class="path-indicator">
            <span class="tab-item">SUMMARY</span>
        </div>
      </div>
      <div class="divider"></div>
      <div class="scroll-content">
          <div class="transcript-items">
              {# include "transcription.html" #}
              <p>Loading transcription…</p>
          </div>
          <div class="summary-content">
              {# include "summary.html" #}
              <p>Loading summary…</p>
          </div>
      </div>
    </div>
</div>

{% endblock %}

{% block script %}
    const startTime = {{ call['startDate'] }};
    const endTime = {{ call.get('endDate') or getTimestamp() }};
    const initialOffset = {{ offset }};

    const track = document.querySelector("audio");
    const tabs = document.querySelectorAll(".path-indicator");
    const scrollView = document.querySelector(".scroll-content");

    var segments = document.querySelectorAll(".transcript-section");
    var activeSegment = undefined;
    var activeTopic = undefined;
    var firstUpdate = true;

    function activeTab() {
      return document.querySelector(".path-indicator-active").id; 
    }

    function onTimeUpdate(offset) {
      if (firstUpdate) {
        firstUpdate = false;
      } else {
        if (offset < 10 || (track.duration < 20 && offset < track.duration / 2)) {
          layer1.post({timeUpdate: startTime + offset, frame: "trailing"});
        } else if (track.duration - offset < 10 || (track.duration < 20 && offset > track.duration / 2)) {
          layer1.post({timeUpdate: Math.min(endTime, startTime + offset), frame: "leading"});
        } else {
          layer1.post({timeUpdate: startTime + offset, frame: "closest"});
        }
      }

      if (segments.length == 0) {
        return
      }

      var seg = segments[0];
      for (let s of segments) {
          if (parseFloat(s.getAttribute("data-time")) <= offset + 0.001) {
              seg = s;
          } else {
              break;
          }
      }
      
      if (seg != undefined && seg != activeSegment) {
          console.log("New segment:", seg.getAttribute("data-time"));
          seg.classList.add("transcript-section-active");
          if (autoscroll && activeTab() == "transcription") {
            seg.scrollIntoView({block: "center", behavior: "smooth"});
          }
          if (activeSegment) {
              activeSegment.classList.remove("transcript-section-active");
          }
          activeSegment = seg;
      }

      const topics = document.querySelectorAll(".topic");

      if (topics.length == 0) {
        return
      }

      var top = topics[0];
      for (let t of topics) {
          if (parseFloat(t.getAttribute("data-time")) <= offset + 0.001) {
              top = t;
          } else {
              break;
          }
      }
      
      if (top != undefined && top != activeTopic) {
          console.log("New topic:", top.getAttribute("data-time"));
          top.classList.add("topic-active");
          if (autoscroll && activeTab() == "summary") {
            top.scrollIntoView({block: "center", behavior: "smooth"});
          }
          if (activeTopic) {
            activeTopic.classList.remove("topic-active");
          }
          activeTopic = top;
      }
    }

    var autoscroll = true;

    track.onplay = (event) => {
        autoscroll = true;
    };

    window.onmousewheel = (event) => {
        autoscroll = false;
    };

    track.onloadedmetadata = (event) => {
      track.currentTime = Math.min(initialOffset, track.duration);
    };

    track.ontimeupdate = (event) => {
      onTimeUpdate(track.currentTime);
    };

    function syncVisibility() {
      switch (activeTab()) {
        case "transcription":
          var needScroll = (document.querySelector(".transcript-items").style.display != "flex");
          document.querySelector(".transcript-items").style.display = "flex";
          document.querySelector(".summary-content").style.display = "none";
          if (needScroll && activeSegment) {
            activeSegment.scrollIntoView({block: "center"});
          }
          break;
        case "summary":
          document.querySelector(".transcript-items").style.display = "none";
          document.querySelector(".summary-content").style.display = "flex";
          if (activeTopic) {
            activeTopic.scrollIntoView();
          } else {
            document.querySelector(".summary-content").scrollIntoView();
          }
          break;
        default:
          break;
      }
    }

    function activateTab(el) {
      for (let tj of tabs) {
        if (el == tj) {
          tj.classList.add("path-indicator-active");
        } else {
          tj.classList.remove("path-indicator-active");
        }
      }
      syncVisibility();
      layer1.post({ tab: el.id });
    }

    function selectTab(name) {
      const tab = document.getElementById(name);
      if (tab) {
        activateTab(tab);
      }
    }

    selectTab("{{ tab or "transcription" }}");

    for (let ti of tabs) {
      ti.onclick = (event) => {
        activateTab(ti);
      };
    }

    function updateTranscript() {
        segments = document.querySelectorAll(".transcript-section");
        for (let s of segments) {
            s.onclick = (event) => {
                track.currentTime = Math.min(parseFloat(s.getAttribute("data-time")), track.duration);
            };
        }
    }

    updateTranscript();

    function updateTopics() {
        for (let t of document.querySelectorAll(".topic-title")) {
            t.onclick = (event) => {
                track.currentTime = Math.min(parseFloat(t.parentNode.getAttribute("data-time")), track.duration);
            };
        }

        const summaryButton = document.getElementById("summary-button");

        if (summaryButton) {
            summaryButton.onclick = (event) => {
                layer1.post({ summary: {{ call['id'] }} });
                event.target.textContent = "Generating summary…";
                event.target.classList.add("clicked");
                event.target.onclick = null;
            };
        }
    }

    updateTopics();

    for (let p of document.querySelectorAll(".participant")) {
      p.onclick = (event) => {
          layer1.post({ participant: p.textContent });
      };
    }

    function resizeScrollView() {
      scrollView.style.height = "calc(100vh - " + scrollView.getBoundingClientRect().top + "px - 6px)";
    }

    window.onresize = (event) => {
        switch (activeTab()) {
          case "transcription":
            if (activeSegment) {
              activeSegment.scrollIntoView({block: "center"});
            }
            break;
          case "summary":
            break;
          default:
            break;
        }
        resizeScrollView();
    };

    window.onload = (event) => {
      resizeScrollView();
      layer1.post({ loaded: "call:{{ call['id'] }}" });
    };

    document.onkeydown = (event) => {
        if (event.isComposing || event.altKey || event.ctrlKey || event.shiftKey || event.metaKey) {
            return;
        }
        if (document.activeElement && document.activeElement.tagName != "BODY") {
            return;
        }
        if (event.code == "Space") {
            if (track.paused) {
                track.play();
            } else {
                track.pause();
            }
            event.preventDefault();
            return;
        }
        if (event.code == "ArrowUp") {
            const s = document.querySelector(".transcript-section:has(+ .transcript-section-active)");
            if (s) {
                track.currentTime = Math.min(parseFloat(s.getAttribute("data-time")), track.duration);
            }
            event.preventDefault();
            return;
        }
        if (event.code == "ArrowDown") {
            const s = document.querySelector(".transcript-section-active + .transcript-section");
            if (s) {
                track.currentTime = Math.min(parseFloat(s.getAttribute("data-time")), track.duration);
            }
            event.preventDefault();
            return;
        }
    };

    var callTitle = `{{ title }}`;
    const callTitleEl = document.querySelector(".call-name-title");

    callTitleEl.onkeydown = (event) => {
        if (event.isComposing || event.altKey || event.ctrlKey || event.shiftKey || event.metaKey) {
            return;
        }
        if (event.code == "Enter") {
            var newTitle = event.target.textContent.replaceAll("\n", " ").trim();
            if (newTitle && newTitle != callTitle) {
                callTitle = newTitle;
                layer1.post({ title: newTitle, callId: {{ call['id'] }} });
            }
            event.target.blur()
            event.preventDefault();
            return;
        }
        if (event.code == "Escape") {
            event.target.blur()
            event.preventDefault();
            return;
        }
    };

    callTitleEl.onfocus = (event) => {
        callTitle = event.target.textContent;
    };

    callTitleEl.onblur = (event) => {
        event.target.textContent = callTitle;
    };

{% endblock %}

</html>
